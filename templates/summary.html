{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 slide-in">
    <h2 class="text-center mb-4">üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤—Å–µ—Ö –∫–∞—Å—Å</h2>
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –¥–∞—Ç –∏ —Å–º–µ–Ω—ã -->
<form action="/summary" method="get" class="row g-3 mb-4">
    <div class="col-md-3">
        <input type="date" id="start_date" name="start_date" class="form-control" value="{{ selected_start_date }}" required>
    </div>
    <div class="col-md-3">
        <input type="date" id="end_date" name="end_date" class="form-control" value="{{ selected_end_date }}" required>
    </div>
    <div class="col-md-3">
        <select id="shift_filter" name="shift" class="form-control">
            <option value="" {% if not selected_shift %}selected{% endif %}>–í—Å–µ —Å–º–µ–Ω—ã</option>
            <option value="–£—Ç—Ä–µ–Ω–Ω—è—è" {% if selected_shift == '–£—Ç—Ä–µ–Ω–Ω—è—è' %}selected{% endif %}>–£—Ç—Ä–µ–Ω–Ω—è—è</option>
            <option value="–î–Ω–µ–≤–Ω–∞—è" {% if selected_shift == '–î–Ω–µ–≤–Ω–∞—è' %}selected{% endif %}>–î–Ω–µ–≤–Ω–∞—è</option>
            <option value="–í–µ—á–µ—Ä–Ω—è—è" {% if selected_shift == '–í–µ—á–µ—Ä–Ω—è—è' %}selected{% endif %}>–í–µ—á–µ—Ä–Ω—è—è</option>
        </select>
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á–µ—Ç</button>
    </div>
</form>


    <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
    <div class="d-flex justify-content-end mb-3">
        <a id="download_excel" href="#" class="btn btn-success me-2"><i class="fas fa-file-excel"></i> –°–∫–∞—á–∞—Ç—å Excel</a>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∏—Ç–æ–≥–æ–≤ -->
    <div class="table-responsive shadow-sm p-3 bg-white rounded">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>–ö–∞—Å—Å–∏—Ä</th>
                    <th>–°–º–µ–Ω–∞</th>
                    <th>Z-–æ—Ç—á—ë—Ç</th>
                    <th>HUMO</th>
                    <th>UZCARD</th>
                    <th>–ù–∞–ª–∏—á–Ω—ã–µ</th>
                    <th>Click/Payme</th>
                    <th>–†–∞–∑–Ω–∏—Ü–∞</th>
                    <th>–î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr class="{{ 'table-danger' if report.difference < 0 else 'table-warning' if report.difference > 0 else 'table-success' }}">
                    <td>{{ report.id }}</td>
                    <td>{{ report.cashier }}</td>
                    <td>{{ report.shift }}</td>
                    <td>{{ '%.2f'|format(report.z_report) }}</td>
                    <td>{{ '%.2f'|format(report.humo) }}</td>
                    <td>{{ '%.2f'|format(report.uzcard) }}</td>
                    <td>{{ '%.2f'|format(report.cash) }}</td>
                    <td>{{ '%.2f'|format(report.click_payme) }}</td>
                    <td>{{ '%.2f'|format(report.difference) }}</td>
                    <td>{{ report.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="mt-5">
        <h4 class="text-center">üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –∫–∞—Å—Å–∞–º</h4>
        <div id="chart"></div>
    </div>

    <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="mt-4">
        <h4>–û–±—â–∏–π –∏—Ç–æ–≥:</h4>
        <ul class="list-group shadow-sm">
            <li class="list-group-item">–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ Z-–æ—Ç—á–µ—Ç—É: {{ '%.2f'|format(total_z_report) }} {{ settings.currency }}</li>
            <li class="list-group-item">–û–±—â–∞—è —Å—É–º–º–∞ HUMO: {{ '%.2f'|format(total_humo) }} {{ settings.currency }}</li>
            <li class="list-group-item">–û–±—â–∞—è —Å—É–º–º–∞ UZCARD: {{ '%.2f'|format(total_uzcard) }} {{ settings.currency }}</li>
            <li class="list-group-item">–û–±—â–∞—è —Å—É–º–º–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö: {{ '%.2f'|format(total_cash) }} {{ settings.currency }}</li>
            <li class="list-group-item">–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ Click/Payme: {{ '%.2f'|format(total_click_payme) }} {{ settings.currency }}</li>
            <li class="list-group-item">–û–±—â–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: {{ '%.2f'|format(total_difference) }} {{ settings.currency }}</li>
        </ul>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    const graphData = { graph_jsontojsonsafe };
    Plotly.react('chart', graphData.data, graphData.layout);
</script>

<!-- ‚úÖ –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è Excel —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å–º–µ–Ω–µ -->
<script>
    document.getElementById("download_excel").addEventListener("click", function (e) {
        e.preventDefault();  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ

        let startDate = document.getElementById("start_date").value;
        let endDate = document.getElementById("end_date").value;
        let shift = document.getElementById("shift_filter").value;  // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–º–µ–Ω—É

        if (!startDate || !endDate) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç!");
            return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL —Å —É—á–µ—Ç–æ–º —Å–º–µ–Ω—ã
        let downloadUrl = `/download_all_excel?start_date=${startDate}&end_date=${endDate}&shift=${shift}`;

        // –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ URL (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ Excel)
        window.location.href = downloadUrl;
    });
</script>

{% endblock %}
